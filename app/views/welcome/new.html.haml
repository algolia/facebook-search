- if current_user || @tag
  #signout-link.hidden-xs
    - if @tag
      = link_to "Try it now!", root_path
    - else
      = link_to "Sign out", signout_path, method: :delete
  #search-form.form
    %input.form-control#q{type: 'text', autocomplete: 'off', autocorrect: 'off', spellcheck: 'false', placeholder: 'Search by keywords'}
    %small
      Realtime Search by
      = link_to 'http://www.algolia.com' do
        = image_tag "http://www.algolia.com/assets/algolia_white.png"
  .container-wrapper
    .container
      #stats.hidden-xs
      #social-links
        %a.twitter-follow-button{href: "https://twitter.com/algolia", "data-show-count" => "false", "data-show-screen-name" => "true"}Follow @algolia
        %a.twitter-share-button{href: "https://twitter.com/share", "data-url" => root_url, "data-via" => "algolia", 'data-text' => 'Rethink the way you search your Facebook feed'} Tweet
    #hits-wrapper{style: 'display: none'}
      .container
        .row
          #facets.col-lg-2.col-sm-3.hidden-xs
          #hits.col-lg-6.col-sm-8.col-xs-12
    #no-results{style: 'display: none'}
      %p.text-center No results are matching your query.
    #loading{style: 'display: none'}
      %p.text-center
        %i.glyphicon.glyphicon-refresh.icon-rotation
        We're retrieving your feed, please wait...
        %br
        %small.text-muted Could take up to 2 minutes depending on your feed activity.

  %script#comments-template{type: 'text/template'}
    :plain
      {{#total_count}}
        <div class="actions">
          <div class="pull-right">
            {{#likes_count}}
              <i class="fa fa-thumbs-o-up"></i>
              {{ likes_count }}
            {{/likes_count}}
            {{#comments_count}}
              <i class="fa fa-comments-o"></i>
              {{ comments_count }}
            {{/comments_count}}
          </div>
          <div class="pull-left">
            {{#actions}}
              <a href="{{ link }}">{{ name }}</a>
            {{/actions}}
          </div>
          <div class="clearfix"></div>
        </div>
      {{/total_count}}
      {{#comments}}
      <div class="comments">
        {{#comments.data}}
          <div class="comment">
            <a href="http://facebook.com/{{ from.id }}" class="thumb"> 
              <img src="http://graph.facebook.com/{{ from.id }}/picture" />
            </a>
            <p>
              <strong><a href="http://facebook.com/{{ from.id }}">{{ from.name }}</a></strong>
              {{{ _highlightResult.message.value }}}
              {{#like_count}}
              <i class="fa fa-thumbs-o-up"></i>
              <strong>{{ like_count }}</strong>
              {{/like_count}}
              <abbr class="timeago" title="{{ created_time }}">{{ created_time }}</abbr>
            </p>
            <div class="clearfix"></div>
          </div>
        {{/comments.data}}
      </div>
      {{/comments}}

  %script#status-template{type: 'text/template'}
    :plain
      <div class="title">
        <a href="http://facebook.com/{{ from.id }}"> 
          <img src="http://graph.facebook.com/{{ from.id }}/picture" />
        </a>
        <h4>
          {{{ story }}} 
          <abbr class="timeago" title="{{ created_time }}">{{ created_time }}</abbr>
        </h4>
      </div>
      <div class="content">
        <p>{{{ _highlightResult.message.value }}}</p>
      </div>

  %script#photo-template{type: 'text/template'}
    :plain
      <div class="title">
        <a href="http://facebook.com/{{ from.id }}"> 
          <img src="http://graph.facebook.com/{{ from.id }}/picture" />
        </a> 
        <h4>
          {{{ story }}} 
          <abbr class="timeago" title="{{ created_time }}">{{ created_time }}</abbr>
        </h4>
      </div> 
      <div class="content">
        <p>{{{ _highlightResult.message.value }}}</p>
        <div class="picture_container">
          <a target="_blank" href="{{ link }}"> 
            <img src="{{ picture }}" />
          </a>
        </div>
      </div>

  %script#link-template{type: 'text/template'}
    :plain
      <div class="title">
        <a href="http://facebook.com/{{ from.id }}">
          <img src="http://graph.facebook.com/{{ from.id }}/picture" />
        </a>
        <h4>
          {{{ story }}}
          <abbr class="timeago" title="{{ created_time }}">{{ created_time }}</abbr>
        </h4>
      </div>
      <div class="content">
        <p>{{{ _highlightResult.message.value }}}</p>
        {{#name}}
          <div class="link_container">
            <div class="text-center"><img class="pic" src="{{ picture }}" /></div>
            <div class="description">
              <h3>{{{ _highlightResult.name.value }}}</h3>
              <p>{{{ _highlightResult.description.value }}}</p>
            </div>
          </div>
        {{/name}}
      </div>

  %script#video-template{type: 'text/template'}
    :plain
      <div class="title">
        <a href="http://facebook.com/{{ from.id }}"> 
          <img src="http://graph.facebook.com/{{ from.id }}/picture" />
        </a> 
        <h4>
          {{{ story }}} 
          <abbr class="timeago" title="{{ created_time }}">{{ created_time }}</abbr>
        </h4>
      </div>
      <div class="content">
        <p>{{{ _highlightResult.name.value }}}</p>
        <div class="video_container">
            <div class="text-center"><img class="pic" src="{{ picture }}" /></div>
            <div class="description">
              <h4>{{{ _highlightResult.name.value }}}</h4>
              <a href="{{ link }}">{{ link }}</a>
            </div>
        </div>
      </div>      

  %script#checkin-template{type: 'text/template'}
    :plain
      <div class="title">
        <a href="http://facebook.com/{{ from.id }}"> 
          <img src="http://graph.facebook.com/{{ from.id }}/picture" />
        </a> 
        <h4>
          {{{ story }}} 
          <abbr class="timeago" title="{{ created_time }}">{{ created_time }}</abbr>
        </h4>
      </div> 
      <div class="content">
        <p>{{ caption }}</p>
        <div class="picture_container">
          <a target="_blank" href="{{ link }}"> 
            <img src="{{ picture }}" />
          </a>
        </div>
      </div>

  :javascript
    $(document).ready(function() {
      var algolia = new AlgoliaSearch('#{ENV['ALGOLIA_APPLICATION_ID']}', '#{@secured_api_key}');
      algolia.setSecurityTags('#{current_user.uid}');
      var $hits = $('#hits');
      var $facets = $('#facets');
      var $hitsWrapper = $('#hits-wrapper');
      var $noResults = $('#no-results');
      var $stats = $('#stats');
      var $loading = $('#loading');
      var $q = $('#q');
      var templates = {
        status: Hogan.compile($('#status-template').text()),
        photo: Hogan.compile($('#photo-template').text()),
        link: Hogan.compile($('#link-template').text()),
        video: Hogan.compile($('#video-template').text()),
        checkin: Hogan.compile($('#checkin-template').text()),
        comments: Hogan.compile($('#comments-template').text()),
      };
      var LABELS = {
        'application.name' : 'Application',
        'type' : 'Type',
        'from.name' : 'From',
        'story_tags.name' : 'Tags'
      };

      window.helper = new AlgoliaSearchHelper(algolia, 'facebook_#{Rails.env}', {
        hitsPerPage: 10,
        facets: ['application.name', 'type', 'from.name', 'story_tags.name']
      });

      var loading = true;
      function searchCallback(success, content) {
        if (!success || $q.val() != content.query) {
          return;
        }

        if (loading) {
          $loading.show();
          algolia.clearCache();
          if (content.hits.length < 2) {
            $hitsWrapper.hide();
            $noResults.hide();
            $stats.hide();
            $loading.show();
            setTimeout(search, 1000);
            return;
          }
          loading = false;
        }
        $loading.hide();

        if (content.hits.length === 0) {
          $hits.empty();
          $stats.empty();
          $hitsWrapper.hide();
          $noResults.show();
          return;
        }
        $hitsWrapper.show();
        $stats.show();
        $noResults.hide();

        $stats.html('<b>' + content.nbHits + '</b> result' + (content.nbHits > 1 ? 's' : '') + ' in <b>' + content.processingTimeMS + '</b> ms');

        var html = '';
        for (var i = 0; i < content.hits.length; ++i) {
          var hit = content.hits[i];
          var template = templates[hit.type];
          if (!template) {
            continue;
          }

          if (!hit.story) {
            hit.story = '<strong><a href="http://facebook.com/' + hit.from.id + '">' + hit.from.name + '</a></strong>';
          }
          if (hit.story_tags) {
            $.each(hit.story_tags, function() {
              hit.story = hit.story.replace(this.name, '<strong><a href="http://facebook.com/' + this.id + '">' + this.name + '</a></strong>');
            });
          }

          if (hit.comments) {
            for (var j = 0; j < hit.comments.data.length; ++j) {
              hit.comments.data[j]._highlightResult = hit._highlightResult.comments.data[j];
            }
          }

          if (hit.comments_count || hit.likes_count) {
            hit.total_count = hit.comments_count + hit.likes_count;
          }

          html += '<div class="hit">' +
            template.render(hit) +
            templates.comments.render(hit) +
            '</div>';
        }
        $hits.html(html);

        html = '';
        for (var facet in content.facets) {
          var values = [];
          for (var f in content.facets[facet]) {
            values.push([f, content.facets[facet][f]]);
          }
          values.sort(function(a, b) { b[1] - a[1] });
          html += '<div class="title">' + LABELS[facet] + '</div>' +
            '<ul class="list-unstyled">' +
              $.map(values, function(e) { return '<li class="' + (helper.isRefined(facet, e[0]) ? 'active' : '') + '"><a href="#" onclick="helper.toggleRefine(\'' + facet + '\', \'' + e[0] + '\'); return false;">' + e[0] + '</a> (' + e[1] + ')'; }).join('') +
            '</ul>';
        }
        $facets.html(html);

        $("abbr.timeago").timeago();
      }

      window.search = function() {
        helper.search($q.val(), searchCallback, {
          page: 0,
          maxValuesPerFacet: 10,
          hitsPerPage: 10,
          advancedSyntax: true,
          queryType: 'prefixAll',
          minWordSizefor1Typo: 4,
          minWordSizefor2Typos: 7,
        });
      };
      
      $q.on('keyup change', function() {
        window.search();
      }).focus();

      window.search();
    });
- else
  #signin-link
    %h1.text-center
      Facebook Search by
      = link_to "http://www.algolia.com" do
        = image_tag "http://www.algolia.com/assets/algolia_white.png"
      %br
      %em
        %small Rethink the way you search your Facebook feed.
    = link_to "Try with your Facebook account", '/auth/facebook', class: 'login'
    %p.text-center
      %em Your data will be <u>securely</u> indexed, only searchable by You. No spam, ever.

:javascript
  !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");
